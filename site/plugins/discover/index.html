
<!doctype html>
<html lang="en" class="no-js">
  <head>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">




        <link rel="prev" href="../">


        <link rel="next" href="../provision/">


      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">



        <title>Discover - tmt</title>



      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">












        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>



      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">

    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>






  </head>


    <body dir="ltr">


    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">


        <a href="#discover" class="md-skip">
          Skip to content
        </a>

    </div>
    <div data-md-component="announce">

    </div>






<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="tmt" class="md-header__button md-logo" aria-label="tmt" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">

      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tmt
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">

              Discover

          </span>
        </div>
      </div>
    </div>


      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>





        <label class="md-header__button md-icon" for="__search">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">

        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">

          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>

    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>



      <div class="md-header__source">
        <a href="https://github.com/teemtee/tmt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">

    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>

  </nav>

</header>

    <div class="md-container" data-md-component="container">






      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">



              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="tmt" class="md-nav__button md-logo" aria-label="tmt" data-md-component="logo">


  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    tmt
  </label>

    <div class="md-nav__source">
      <a href="https://github.com/teemtee/tmt" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">

    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>

  <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">



  <span class="md-ellipsis">
    Home

  </span>


      </a>
    </li>









    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">



  <span class="md-ellipsis">
    Overview

  </span>


      </a>
    </li>









    <li class="md-nav__item">
      <a href="../../guide/" class="md-nav__link">



  <span class="md-ellipsis">
    Guide

  </span>


      </a>
    </li>
















    <li class="md-nav__item md-nav__item--active md-nav__item--nested">



        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>


          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">



  <span class="md-ellipsis">
    Plugins

  </span>


            <span class="md-nav__icon md-icon"></span>
          </label>

        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Plugins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>







    <li class="md-nav__item">
      <a href="../" class="md-nav__link">



  <span class="md-ellipsis">
    Overview

  </span>


      </a>
    </li>












    <li class="md-nav__item md-nav__item--active">

      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">





        <label class="md-nav__link md-nav__link--active" for="__toc">



  <span class="md-ellipsis">
    Discover

  </span>


          <span class="md-nav__icon md-icon"></span>
        </label>

      <a href="./" class="md-nav__link md-nav__link--active">



  <span class="md-ellipsis">
    Discover

  </span>


      </a>



<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#fmf" class="md-nav__link">
    <span class="md-ellipsis">
      fmf
    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf" class="md-nav__link">
    <span class="md-ellipsis">
      DiscoverFmf
    </span>
  </a>

    <nav class="md-nav" aria-label="DiscoverFmf">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.is_in_standalone_mode" class="md-nav__link">
    <span class="md-ellipsis">
      is_in_standalone_mode
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.do_the_discovery" class="md-nav__link">
    <span class="md-ellipsis">
      do_the_discovery
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.get_git_root" class="md-nav__link">
    <span class="md-ellipsis">
      get_git_root
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.go" class="md-nav__link">
    <span class="md-ellipsis">
      go
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.post_dist_git" class="md-nav__link">
    <span class="md-ellipsis">
      post_dist_git
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.process_distgit_source" class="md-nav__link">
    <span class="md-ellipsis">
      process_distgit_source
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.tests" class="md-nav__link">
    <span class="md-ellipsis">
      tests
    </span>
  </a>

</li>

      </ul>
    </nav>

</li>

        <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    <span class="md-ellipsis">
      shell
    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell" class="md-nav__link">
    <span class="md-ellipsis">
      DiscoverShell
    </span>
  </a>

    <nav class="md-nav" aria-label="DiscoverShell">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.fetch_remote_repository" class="md-nav__link">
    <span class="md-ellipsis">
      fetch_remote_repository
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.go" class="md-nav__link">
    <span class="md-ellipsis">
      go
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.show" class="md-nav__link">
    <span class="md-ellipsis">
      show
    </span>
  </a>

</li>

      </ul>
    </nav>

</li>

    </ul>

</nav>

    </li>










    <li class="md-nav__item">
      <a href="../provision/" class="md-nav__link">



  <span class="md-ellipsis">
    Provision

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../prepare/" class="md-nav__link">



  <span class="md-ellipsis">
    Prepare

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../execute/" class="md-nav__link">



  <span class="md-ellipsis">
    Execute

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../report/" class="md-nav__link">



  <span class="md-ellipsis">
    Report

  </span>


      </a>
    </li>










    <li class="md-nav__item">
      <a href="../finish/" class="md-nav__link">



  <span class="md-ellipsis">
    Finish

  </span>


      </a>
    </li>




          </ul>
        </nav>

    </li>



  </ul>
</nav>
                  </div>
                </div>
              </div>



              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">






    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>

        <li class="md-nav__item">
  <a href="#fmf" class="md-nav__link">
    <span class="md-ellipsis">
      fmf
    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf" class="md-nav__link">
    <span class="md-ellipsis">
      DiscoverFmf
    </span>
  </a>

    <nav class="md-nav" aria-label="DiscoverFmf">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.is_in_standalone_mode" class="md-nav__link">
    <span class="md-ellipsis">
      is_in_standalone_mode
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.do_the_discovery" class="md-nav__link">
    <span class="md-ellipsis">
      do_the_discovery
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.get_git_root" class="md-nav__link">
    <span class="md-ellipsis">
      get_git_root
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.go" class="md-nav__link">
    <span class="md-ellipsis">
      go
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.post_dist_git" class="md-nav__link">
    <span class="md-ellipsis">
      post_dist_git
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.process_distgit_source" class="md-nav__link">
    <span class="md-ellipsis">
      process_distgit_source
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.fmf.DiscoverFmf.tests" class="md-nav__link">
    <span class="md-ellipsis">
      tests
    </span>
  </a>

</li>

      </ul>
    </nav>

</li>

        <li class="md-nav__item">
  <a href="#shell" class="md-nav__link">
    <span class="md-ellipsis">
      shell
    </span>
  </a>

</li>

        <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell" class="md-nav__link">
    <span class="md-ellipsis">
      DiscoverShell
    </span>
  </a>

    <nav class="md-nav" aria-label="DiscoverShell">
      <ul class="md-nav__list">

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.fetch_remote_repository" class="md-nav__link">
    <span class="md-ellipsis">
      fetch_remote_repository
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.go" class="md-nav__link">
    <span class="md-ellipsis">
      go
    </span>
  </a>

</li>

          <li class="md-nav__item">
  <a href="#tmt.steps.discover.shell.DiscoverShell.show" class="md-nav__link">
    <span class="md-ellipsis">
      show
    </span>
  </a>

</li>

      </ul>
    </nav>

</li>

    </ul>

</nav>
                  </div>
                </div>
              </div>



            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">








<h1 id="discover">Discover<a class="headerlink" href="#discover" title="Permanent link">&para;</a></h1>
<p>Gather information about test cases to be executed.</p>
<h2 id="fmf">fmf<a class="headerlink" href="#fmf" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="tmt.steps.discover.fmf.DiscoverFmf" class="doc doc-heading">
            <code>tmt.steps.discover.fmf.DiscoverFmf</code>


<a href="#tmt.steps.discover.fmf.DiscoverFmf" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="tmt.steps.discover.DiscoverPlugin">DiscoverPlugin</span>[<span title="tmt.steps.discover.fmf.DiscoverFmfStepData">DiscoverFmfStepData</span>]</code></p>


        <p>Discover available tests from fmf metadata.</p>
<p>By default all available tests from the current repository are used
so the minimal configuration looks like this:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
</code></pre></div>
<p>Full config example:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    url: https://github.com/teemtee/tmt
    ref: main
    path: /fmf/root
    test: /tests/basic
    filter: &#39;tier: 1&#39;
</code></pre></div>
<p>If no <code>ref</code> is provided, the default branch from the origin is used.</p>
<p>Dist Git
^^^^^^^^</p>
<p>For DistGit repo one can download sources and use code from them in
the tests. Sources are extracted into <code>$TMT_SOURCE_DIR</code> path,
patches are applied by default. See options to install build
dependencies or to just download sources without applying patches.
To apply patches, special <code>prepare</code> phase with order <code>60</code> is
added, and <code>prepare</code> step has to be enabled for it to run.</p>
<p>It can be used together with <code>ref</code>, <code>path</code> and <code>url</code>,
however <code>ref</code> is not possible without using <code>url</code>.</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    dist-git-source: true
</code></pre></div>
<p>Name Filter
^^^^^^^^^^^</p>
<p>Use the <code>test</code> key to limit which tests should be executed by
providing regular expression matching the test name:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    test: ^/tests/area/.*
</code></pre></div>
<p>.. code-block:: shell</p>
<div class="highlight"><pre><span></span><code>tmt run discover --how fmf --verbose --test &quot;^/tests/core.*&quot;
</code></pre></div>
<p>When several regular expressions are provided, tests matching each
regular expression are concatenated. In this way it is possible to
execute a single test multiple times:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    test:
      - ^/test/one$
      - ^/test/two$
      - ^/special/setup$
      - ^/test/one$
      - ^/test/two$
</code></pre></div>
<p>.. code-block:: shell</p>
<div class="highlight"><pre><span></span><code>tmt run discover -h fmf -v -t &#39;^/test/one$&#39; -t &#39;^/special/setup$&#39; -t &#39;^/test/two$&#39;
</code></pre></div>
<p>The <code>include</code> key also allows to select tests by name, with two
important distinctions from the <code>test</code> key:</p>
<ul>
<li>
<p>The original test :ref:<code>/spec/core/order</code> is preserved so it does
  not matter in which order tests are listed under the <code>include</code>
  key.</p>
</li>
<li>
<p>Test duplication is not allowed, so even if a test name is
  repeated several times, test will be executed only once.</p>
</li>
</ul>
<p>Finally, the <code>exclude</code> key can be used to specify regular
expressions matching tests which should be skipped during the
discovery.</p>
<p>The <code>test</code>, <code>include</code> and <code>exclude</code> keys use search mode for
matching patterns. See the :ref:<code>regular-expressions</code> section for
detailed information about how exactly the regular expressions are
handled.</p>
<p>Link Filter
^^^^^^^^^^^</p>
<p>Selecting tests containing specified link is possible using <code>link</code>
key accepting <code>RELATION:TARGET</code> format of values. Regular
expressions are supported for both relation and target part of the
value. Relation can be omitted to target match any relation.</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    link: verifies:.*issue/850$
</code></pre></div>
<p>Advanced Filter
^^^^^^^^^^^^^^^</p>
<p>The <code>filter</code> key can be used to apply an advanced filter based on
test metadata attributes. These can be especially useful when tests
are grouped by the :ref:<code>/spec/core/tag</code> or :ref:<code>/spec/core/tier</code>
keys:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    filter: tier:3 &amp; tag:provision
</code></pre></div>
<p>.. code-block:: shell</p>
<div class="highlight"><pre><span></span><code>tmt run discover --how fmf --filter &quot;tier:3 &amp; tag:provision&quot;
</code></pre></div>
<p>See the <code>pydoc fmf.filter</code> documentation for more details about
the supported syntax and available operators.</p>
<p>Modified Tests
^^^^^^^^^^^^^^</p>
<p>It is also possible to limit tests only to those that have changed
in git since a given revision. This can be particularly useful when
testing changes to tests themselves (e.g. in a pull request CI).</p>
<p>Related keys: <code>modified-only</code>, <code>modified-url</code>, <code>modified-ref</code></p>
<p>Example to compare local repo against upstream <code>main</code> branch:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    modified-only: True
    modified-url: https://github.com/teemtee/tmt
    modified-ref: reference/main
</code></pre></div>
<p>Note that internally the modified tests are appended to the list
specified via <code>test</code>, so those tests will also be selected even if
not modified.</p>
<p>Adjust Tests
^^^^^^^^^^^^</p>
<p>Use the <code>adjust-tests</code> key to modify the discovered tests'
metadata directly from the plan. For example, extend the test
duration for slow hardware or modify the list of required packages
when you do not have write access to the remote test repository.
The value should follow the <code>adjust</code> rules syntax.</p>
<p>The following example adds an <code>avc</code> check for each discovered
test, doubles its duration and replaces each occurrence of the word
<code>python3.11</code> in the list of required packages.</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: fmf
    adjust-tests:
      - check+:
          - how: avc
      - duration+: &#39;*2&#39;
        because: Slow system under test
        when: arch == i286
      - require~:
          - &#39;/python3.11/python3.12/&#39;
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">provides_method</span><span class="p">(</span><span class="s1">&#39;fmf&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DiscoverFmf</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverPlugin</span><span class="p">[</span><span class="n">DiscoverFmfStepData</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover available tests from fmf metadata.</span>

<span class="sd">    By default all available tests from the current repository are used</span>
<span class="sd">    so the minimal configuration looks like this:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>

<span class="sd">    Full config example:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            url: https://github.com/teemtee/tmt</span>
<span class="sd">            ref: main</span>
<span class="sd">            path: /fmf/root</span>
<span class="sd">            test: /tests/basic</span>
<span class="sd">            filter: &#39;tier: 1&#39;</span>

<span class="sd">    If no ``ref`` is provided, the default branch from the origin is used.</span>


<span class="sd">    Dist Git</span>
<span class="sd">    ^^^^^^^^</span>

<span class="sd">    For DistGit repo one can download sources and use code from them in</span>
<span class="sd">    the tests. Sources are extracted into ``$TMT_SOURCE_DIR`` path,</span>
<span class="sd">    patches are applied by default. See options to install build</span>
<span class="sd">    dependencies or to just download sources without applying patches.</span>
<span class="sd">    To apply patches, special ``prepare`` phase with order ``60`` is</span>
<span class="sd">    added, and ``prepare`` step has to be enabled for it to run.</span>

<span class="sd">    It can be used together with ``ref``, ``path`` and ``url``,</span>
<span class="sd">    however ``ref`` is not possible without using ``url``.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            dist-git-source: true</span>

<span class="sd">    Name Filter</span>
<span class="sd">    ^^^^^^^^^^^</span>

<span class="sd">    Use the ``test`` key to limit which tests should be executed by</span>
<span class="sd">    providing regular expression matching the test name:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            test: ^/tests/area/.*</span>

<span class="sd">    .. code-block:: shell</span>

<span class="sd">        tmt run discover --how fmf --verbose --test &quot;^/tests/core.*&quot;</span>

<span class="sd">    When several regular expressions are provided, tests matching each</span>
<span class="sd">    regular expression are concatenated. In this way it is possible to</span>
<span class="sd">    execute a single test multiple times:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            test:</span>
<span class="sd">              - ^/test/one$</span>
<span class="sd">              - ^/test/two$</span>
<span class="sd">              - ^/special/setup$</span>
<span class="sd">              - ^/test/one$</span>
<span class="sd">              - ^/test/two$</span>

<span class="sd">    .. code-block:: shell</span>

<span class="sd">        tmt run discover -h fmf -v -t &#39;^/test/one$&#39; -t &#39;^/special/setup$&#39; -t &#39;^/test/two$&#39;</span>

<span class="sd">    The ``include`` key also allows to select tests by name, with two</span>
<span class="sd">    important distinctions from the ``test`` key:</span>

<span class="sd">    * The original test :ref:`/spec/core/order` is preserved so it does</span>
<span class="sd">      not matter in which order tests are listed under the ``include``</span>
<span class="sd">      key.</span>

<span class="sd">    * Test duplication is not allowed, so even if a test name is</span>
<span class="sd">      repeated several times, test will be executed only once.</span>

<span class="sd">    Finally, the ``exclude`` key can be used to specify regular</span>
<span class="sd">    expressions matching tests which should be skipped during the</span>
<span class="sd">    discovery.</span>

<span class="sd">    The ``test``, ``include`` and ``exclude`` keys use search mode for</span>
<span class="sd">    matching patterns. See the :ref:`regular-expressions` section for</span>
<span class="sd">    detailed information about how exactly the regular expressions are</span>
<span class="sd">    handled.</span>

<span class="sd">    Link Filter</span>
<span class="sd">    ^^^^^^^^^^^</span>

<span class="sd">    Selecting tests containing specified link is possible using ``link``</span>
<span class="sd">    key accepting ``RELATION:TARGET`` format of values. Regular</span>
<span class="sd">    expressions are supported for both relation and target part of the</span>
<span class="sd">    value. Relation can be omitted to target match any relation.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            link: verifies:.*issue/850$</span>

<span class="sd">    Advanced Filter</span>
<span class="sd">    ^^^^^^^^^^^^^^^</span>

<span class="sd">    The ``filter`` key can be used to apply an advanced filter based on</span>
<span class="sd">    test metadata attributes. These can be especially useful when tests</span>
<span class="sd">    are grouped by the :ref:`/spec/core/tag` or :ref:`/spec/core/tier`</span>
<span class="sd">    keys:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            filter: tier:3 &amp; tag:provision</span>

<span class="sd">    .. code-block:: shell</span>

<span class="sd">        tmt run discover --how fmf --filter &quot;tier:3 &amp; tag:provision&quot;</span>

<span class="sd">    See the ``pydoc fmf.filter`` documentation for more details about</span>
<span class="sd">    the supported syntax and available operators.</span>

<span class="sd">    Modified Tests</span>
<span class="sd">    ^^^^^^^^^^^^^^</span>

<span class="sd">    It is also possible to limit tests only to those that have changed</span>
<span class="sd">    in git since a given revision. This can be particularly useful when</span>
<span class="sd">    testing changes to tests themselves (e.g. in a pull request CI).</span>

<span class="sd">    Related keys: ``modified-only``, ``modified-url``, ``modified-ref``</span>

<span class="sd">    Example to compare local repo against upstream ``main`` branch:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            modified-only: True</span>
<span class="sd">            modified-url: https://github.com/teemtee/tmt</span>
<span class="sd">            modified-ref: reference/main</span>

<span class="sd">    Note that internally the modified tests are appended to the list</span>
<span class="sd">    specified via ``test``, so those tests will also be selected even if</span>
<span class="sd">    not modified.</span>

<span class="sd">    Adjust Tests</span>
<span class="sd">    ^^^^^^^^^^^^</span>

<span class="sd">    Use the ``adjust-tests`` key to modify the discovered tests&#39;</span>
<span class="sd">    metadata directly from the plan. For example, extend the test</span>
<span class="sd">    duration for slow hardware or modify the list of required packages</span>
<span class="sd">    when you do not have write access to the remote test repository.</span>
<span class="sd">    The value should follow the ``adjust`` rules syntax.</span>

<span class="sd">    The following example adds an ``avc`` check for each discovered</span>
<span class="sd">    test, doubles its duration and replaces each occurrence of the word</span>
<span class="sd">    ``python3.11`` in the list of required packages.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: fmf</span>
<span class="sd">            adjust-tests:</span>
<span class="sd">              - check+:</span>
<span class="sd">                  - how: avc</span>
<span class="sd">              - duration+: &#39;*2&#39;</span>
<span class="sd">                because: Slow system under test</span>
<span class="sd">                when: arch == i286</span>
<span class="sd">              - require~:</span>
<span class="sd">                  - &#39;/python3.11/python3.12/&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_data_class</span> <span class="o">=</span> <span class="n">DiscoverFmfStepData</span>

    <span class="c1"># Options which require .git to be present for their functionality</span>
    <span class="n">_REQUIRES_GIT</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modified-url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modified-only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fmf-id&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_in_standalone_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enable standalone mode when listing fmf ids</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;fmf_id&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_in_standalone_mode</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_git_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find git root of the path</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-toplevel&quot;</span><span class="p">),</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
            <span class="n">ignore_dry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover available tests</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Check url and path, prepare test directory</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
        <span class="c1"># FIXME: cast() - typeless &quot;dispatcher&quot; method</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># Save the test directory so that others can reference it</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span>
        <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>
        <span class="n">dist_git_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-source&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dist_git_merge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-merge&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># No tests are selected in some cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">Test</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Self checks</span>
        <span class="k">if</span> <span class="n">dist_git_source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dist_git_merge</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">or</span> <span class="n">url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot manipulate with dist-git without the `--dist-git-merge` option.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_import_plan_details</span><span class="p">()</span>

        <span class="c1"># Clone provided git repository (if url given) with disabled</span>
        <span class="c1"># prompt to ignore possibly missing or private repositories</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clone &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="c1"># Shallow clone to speed up testing and</span>
            <span class="c1"># minimize data transfers if ref is not provided</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_clone</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
                <span class="n">shallow</span><span class="o">=</span><span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="n">Environment</span><span class="p">({</span><span class="s2">&quot;GIT_ASKPASS&quot;</span><span class="p">:</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)}),</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span>
        <span class="c1"># Copy git repository root to workdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fmf_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fmf_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">fmf_root</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">fmf_root</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">requires_git</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;sync-repo&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REQUIRES_GIT</span>
            <span class="p">)</span>
            <span class="c1"># Path for distgit sources cannot be checked until the</span>
            <span class="c1"># they are extracted</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dist_git_source</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Provided path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; is not a directory.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dist_git_source</span><span class="p">:</span>
                <span class="c1"># Ensure we&#39;re in a git repo when extracting dist-git sources</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                    <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2"> is not a git repo&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fmf_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;No metadata found in the current directory.&quot;</span><span class="p">)</span>
                <span class="c1"># Check git repository root (use fmf root if not found)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">fmf_root</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Git root not found, using &#39;</span><span class="si">{</span><span class="n">fmf_root</span><span class="si">}</span><span class="s2">.&#39;&quot;</span><span class="p">)</span>
                    <span class="n">git_root</span> <span class="o">=</span> <span class="n">fmf_root</span>
                <span class="c1"># Set path to relative path from the git root to fmf root</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">fmf_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span>
                    <span class="n">git_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">requires_git</span> <span class="k">else</span> <span class="n">fmf_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="c1"># And finally copy the git/fmf root directory to testdir</span>
            <span class="c1"># (for dist-git case only when merge explicitly requested)</span>
            <span class="k">if</span> <span class="n">requires_git</span><span class="p">:</span>
                <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">git_root</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">fmf_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">fmf_root</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_source</span> <span class="ow">or</span> <span class="n">dist_git_merge</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="c1"># Prepare path of the dynamic reference</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">resolve_dynamic_ref</span><span class="p">(</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
                <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">FileError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

        <span class="c1"># Checkout revision if requested</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkout ref &#39;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">)</span>

        <span class="c1"># Show current commit hash if inside a git repository</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                    <span class="s1">&#39;hash&#39;</span><span class="p">,</span>
                    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_hash</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">),</span>
                    <span class="s1">&#39;green&#39;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Dist-git source processing during discover step</span>
        <span class="k">if</span> <span class="n">dist_git_source</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">distgit_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="k">if</span> <span class="n">ref</span> <span class="k">else</span> <span class="n">git_root</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_distgit_source</span><span class="p">(</span><span class="n">distgit_dir</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;Failed to process &#39;dist-git-source&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">error</span>

        <span class="c1"># Discover tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_the_discovery</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Apply tmt run policy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
                <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_distgit_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distgit_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process dist-git source during the discover step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">download_distgit_source</span><span class="p">(</span>
            <span class="n">distgit_dir</span><span class="o">=</span><span class="n">distgit_dir</span><span class="p">,</span>
            <span class="n">target_dir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
            <span class="n">handler_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-type&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Copy rest of files so TMT_SOURCE_DIR has patches, sources and spec file</span>
        <span class="c1"># FIXME &#39;worktree&#39; could be used as sourcedir when &#39;url&#39; is not set</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
            <span class="n">distgit_dir</span><span class="p">,</span>
            <span class="n">sourcedir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># patch &amp; rediscover will happen later in the prepare step</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-download-only&#39;</span><span class="p">):</span>
            <span class="c1"># Check if prepare is enabled, warn user if not</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Sources will not be extracted, prepare step is not enabled.&quot;</span><span class="p">)</span>

            <span class="n">insert_to_prepare_step</span><span class="p">(</span>
                <span class="n">discover_plugin</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">sourcedir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># merge or not, detect later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">extract_tests_later</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tests will be discovered after dist-git patching in prepare.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_the_discovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover the tests</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Original path might adjusted already in go()</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">prune</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prune&#39;</span><span class="p">)</span>
        <span class="c1"># Adjust path and optionally show</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

        <span class="c1"># Prepare the whole tree path</span>
        <span class="n">tree_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tree_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata tree path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

        <span class="c1"># Show filters and test names if provided</span>
        <span class="c1"># Check the &#39;test --filter&#39; option first, then from discover</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">for</span> <span class="n">filter_</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">filter_</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="c1"># Names of tests selected by --test option</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="n">fmf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">listed</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

        <span class="c1"># Check the &#39;test --link&#39; option first, then from discover</span>
        <span class="c1"># FIXME: cast() - typeless &quot;dispatcher&quot; method</span>
        <span class="n">raw_link_needles</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">link_needles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LinkNeedle</span><span class="o">.</span><span class="n">from_spec</span><span class="p">(</span><span class="n">raw_needle</span><span class="p">)</span> <span class="k">for</span> <span class="n">raw_needle</span> <span class="ow">in</span> <span class="n">raw_link_needles</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">link_needle</span> <span class="ow">in</span> <span class="n">link_needles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">link_needle</span><span class="p">),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

        <span class="n">excludes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;exclude&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">includes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;include&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>

        <span class="c1"># Filter only modified tests if requested</span>
        <span class="n">modified_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modified-only&#39;</span><span class="p">)</span>
        <span class="n">modified_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modified-url&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modified_url</span><span class="p">:</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">modified_url</span>
            <span class="n">modified_url</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">clonable_git_url</span><span class="p">(</span><span class="n">modified_url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;modified-url&#39;</span><span class="p">,</span> <span class="n">modified_url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">previous</span> <span class="o">!=</span> <span class="n">modified_url</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original url was &#39;</span><span class="si">{</span><span class="n">previous</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetch also &#39;</span><span class="si">{</span><span class="n">modified_url</span><span class="si">}</span><span class="s2">&#39; as &#39;reference&#39;.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">modified_url</span><span class="p">),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">modified_only</span><span class="p">:</span>
            <span class="n">modified_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;modified-ref&#39;</span><span class="p">,</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">default_branch</span><span class="p">(</span><span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;modified-ref&#39;</span><span class="p">,</span> <span class="n">modified_ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">ref_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--short&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">modified_ref</span><span class="p">)),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">ref_commit</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;modified-ref hash&#39;</span><span class="p">,</span> <span class="n">ref_commit</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">Command</span><span class="p">(</span>
                    <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=&#39;</span><span class="p">,</span> <span class="s1">&#39;--stat&#39;</span><span class="p">,</span> <span class="s1">&#39;--name-only&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modified_ref</span><span class="si">}</span><span class="s2">..HEAD&quot;</span>
                <span class="p">),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;^/</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">directories</span> <span class="k">if</span> <span class="n">directory</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">modified</span><span class="p">:</span>
                    <span class="c1"># Nothing was modified, do not select anything</span>
                    <span class="k">return</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limit to modified test dirs: </span><span class="si">{</span><span class="n">modified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No modified directories between &#39;</span><span class="si">{</span><span class="n">modified_ref</span><span class="si">}</span><span class="s2">..HEAD&#39; found.&quot;</span><span class="p">)</span>
                <span class="c1"># Nothing was modified, do not select anything</span>
                <span class="k">return</span>

        <span class="c1"># Initialize the metadata tree, search for available tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check metadata tree in &#39;</span><span class="si">{</span><span class="n">tree_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">tree_path</span><span class="p">,</span>
            <span class="n">fmf_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">_fmf_context</span><span class="p">,</span>
            <span class="n">additional_rules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">adjust_tests</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
            <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual is False&quot;</span><span class="p">],</span>
            <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">link_needles</span><span class="p">,</span>
            <span class="n">includes</span><span class="o">=</span><span class="n">includes</span><span class="p">,</span>
            <span class="n">excludes</span><span class="o">=</span><span class="n">excludes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
            <span class="c1"># Save fmf metadata</span>
            <span class="n">clonedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span>
            <span class="n">clone_tree_path</span> <span class="o">=</span> <span class="n">clonedir</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_paths</span><span class="p">(</span><span class="n">tree_path</span><span class="p">,</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\.fmf&#39;</span><span class="p">]):</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="p">,</span>
                    <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">tree_path</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Save upgrade plan</span>
            <span class="n">upgrade_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upgrade_path&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">upgrade_path</span><span class="p">:</span>
                <span class="n">upgrade_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">upgrade_path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.fmf&quot;</span>
                <span class="p">(</span><span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">,</span> <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copymode</span><span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">,</span> <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span>

        <span class="c1"># Prefix tests and handle library requires</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="c1"># Propagate `where` key</span>
            <span class="n">test</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverStepData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">where</span>

            <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
                <span class="c1"># Save only current test data</span>
                <span class="k">assert</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="n">relative_test_path</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                    <span class="n">tree_path</span> <span class="o">/</span> <span class="n">relative_test_path</span><span class="p">,</span>
                    <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">relative_test_path</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Copy all parent main.fmf files</span>
                <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">relative_test_path</span>
                <span class="k">while</span> <span class="n">parent_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                    <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">parent_dir</span><span class="o">.</span><span class="n">parent</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># Ensure parent directory exists</span>
                        <span class="p">(</span><span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                            <span class="n">tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">,</span>
                            <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">,</span>
                        <span class="p">)</span>

            <span class="c1"># Prefix test path with &#39;tests&#39; and possible &#39;path&#39; prefix</span>
            <span class="k">assert</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tests&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span> <span class="o">/</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
            <span class="c1"># Check for possible required beakerlib libraries</span>
            <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">require</span> <span class="ow">or</span> <span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">require</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">libraries</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span>
                    <span class="n">original_require</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">require</span><span class="p">,</span>
                    <span class="n">original_recommend</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">,</span>
                    <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                    <span class="n">source_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
                    <span class="n">target_location</span><span class="o">=</span><span class="n">clonedir</span> <span class="k">if</span> <span class="n">prune</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
            <span class="c1"># Clean self.testdir and copy back only required tests and files from clonedir</span>
            <span class="c1"># This is to have correct paths in tests</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">clonedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="c1"># Cleanup clone directories</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post_dist_git</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">created_content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover tests after dist-git applied patches</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Directory to copy out from sources</span>
        <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-extract&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dist_git_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-init&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dist_git_merge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-merge&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dist_git_remove_fmf_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-remove-fmf-root&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
        <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>

        <span class="c1"># &#39;/&#39; means everything which was extracted from the srpm and do not flatten</span>
        <span class="c1"># glob otherwise</span>
        <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="ow">and</span> <span class="n">dist_git_extract</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                    <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sourcedir</span> <span class="o">/</span> <span class="n">dist_git_extract</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t glob &#39;</span><span class="si">{</span><span class="n">dist_git_extract</span><span class="si">}</span><span class="s2">&#39; within extracted sources.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">dist_git_init</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dist_git_extract</span><span class="p">:</span>
                <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">sourcedir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">location</span> <span class="o">=</span> <span class="n">dist_git_extract</span>
            <span class="c1"># User specified location or &#39;root&#39; of extracted sources</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.fmf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                <span class="n">fmf</span><span class="o">.</span><span class="n">Tree</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dist_git_remove_fmf_root</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">extracted_fmf_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_fmf_root</span><span class="p">(</span>
                    <span class="n">sourcedir</span><span class="p">,</span>
                    <span class="n">ignore_paths</span><span class="o">=</span><span class="p">[</span><span class="n">sourcedir</span><span class="p">],</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No fmf root to remove, there isn&#39;t one already.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">((</span><span class="n">dist_git_extract</span> <span class="ow">or</span> <span class="n">extracted_fmf_root</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.fmf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_extract</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">top_fmf_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_fmf_root</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">,</span> <span class="n">ignore_paths</span><span class="o">=</span><span class="p">[</span><span class="n">sourcedir</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">:</span>
                <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>  <span class="c1"># Copy all extracted files as well (but later)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_merge</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Extracted sources do not contain fmf root, &quot;</span>
                        <span class="s2">&quot;merging with plan data. Avoid this warning by &quot;</span>
                        <span class="s2">&quot;explicit use of the &#39;--dist-git-merge&#39; option.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># FIXME - Deprecate this behavior?</span>
                    <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy &#39;</span><span class="si">{</span><span class="n">git_root</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                        <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">git_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="c1"># Copy extracted sources into testdir</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
            <span class="n">flatten</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">flatten</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">copy_these</span> <span class="o">=</span> <span class="n">created_content</span>
            <span class="k">elif</span> <span class="n">dist_git_extract</span><span class="p">:</span>
                <span class="n">copy_these</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist_git_extract</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">copy_these</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_fmf_root</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">to_copy</span> <span class="ow">in</span> <span class="n">copy_these</span><span class="p">:</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">sourcedir</span> <span class="o">/</span> <span class="n">to_copy</span>
                <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                        <span class="n">sourcedir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="k">if</span> <span class="n">flatten</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">)</span>

        <span class="c1"># Discover tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_the_discovery</span><span class="p">()</span>

        <span class="c1"># Add TMT_SOURCE_DIR variable for each test</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

        <span class="c1"># Apply tmt run policy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
                <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="c1"># Inject newly found tests into parent discover at the right position</span>
        <span class="c1"># FIXME</span>
        <span class="c1"># Prefix test name only if multiple plugins configured</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">phases</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># Check discovered tests, modify test name/path</span>
        <span class="k">for</span> <span class="n">test_origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">test_origin</span><span class="o">.</span><span class="n">test</span>

            <span class="n">test</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span><span class="si">}{</span><span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Update test environment with plan environment</span>
            <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">_tests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="n">test</span><span class="o">.</span><span class="n">serial_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">draw_test_serial_number</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tests</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all discovered tests</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phase_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
            <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">is</span> <span class="n">enabled</span>
        <span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="tmt.steps.discover.fmf.DiscoverFmf.is_in_standalone_mode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_in_standalone_mode</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.is_in_standalone_mode" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Enable standalone mode when listing fmf ids</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.do_the_discovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">do_the_discovery</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.do_the_discovery" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Discover the tests</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">do_the_discovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover the tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Original path might adjusted already in go()</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">prune</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prune&#39;</span><span class="p">)</span>
    <span class="c1"># Adjust path and optionally show</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">==</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="c1"># Prepare the whole tree path</span>
    <span class="n">tree_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tree_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata tree path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

    <span class="c1"># Show filters and test names if provided</span>
    <span class="c1"># Check the &#39;test --filter&#39; option first, then from discover</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;filters&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="k">for</span> <span class="n">filter_</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="n">filter_</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="c1"># Names of tests selected by --test option</span>
    <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="n">fmf</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">listed</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="c1"># Check the &#39;test --link&#39; option first, then from discover</span>
    <span class="c1"># FIXME: cast() - typeless &quot;dispatcher&quot; method</span>
    <span class="n">raw_link_needles</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">link_needles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">LinkNeedle</span><span class="o">.</span><span class="n">from_spec</span><span class="p">(</span><span class="n">raw_needle</span><span class="p">)</span> <span class="k">for</span> <span class="n">raw_needle</span> <span class="ow">in</span> <span class="n">raw_link_needles</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">link_needle</span> <span class="ow">in</span> <span class="n">link_needles</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">link_needle</span><span class="p">),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="n">excludes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;exclude&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exclude</span><span class="p">)</span>
    <span class="n">includes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="o">.</span><span class="n">_opt</span><span class="p">(</span><span class="s1">&#39;include&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">include</span><span class="p">)</span>

    <span class="c1"># Filter only modified tests if requested</span>
    <span class="n">modified_only</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modified-only&#39;</span><span class="p">)</span>
    <span class="n">modified_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modified-url&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modified_url</span><span class="p">:</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">modified_url</span>
        <span class="n">modified_url</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">clonable_git_url</span><span class="p">(</span><span class="n">modified_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;modified-url&#39;</span><span class="p">,</span> <span class="n">modified_url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous</span> <span class="o">!=</span> <span class="n">modified_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original url was &#39;</span><span class="si">{</span><span class="n">previous</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetch also &#39;</span><span class="si">{</span><span class="n">modified_url</span><span class="si">}</span><span class="s2">&#39; as &#39;reference&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">modified_url</span><span class="p">),</span>
            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">),</span>
            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">modified_only</span><span class="p">:</span>
        <span class="n">modified_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;modified-ref&#39;</span><span class="p">,</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">default_branch</span><span class="p">(</span><span class="n">repository</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;modified-ref&#39;</span><span class="p">,</span> <span class="n">modified_ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ref_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--short&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">modified_ref</span><span class="p">)),</span>
            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">ref_commit</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span><span class="s1">&#39;modified-ref hash&#39;</span><span class="p">,</span> <span class="n">ref_commit</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">Command</span><span class="p">(</span>
                <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=&#39;</span><span class="p">,</span> <span class="s1">&#39;--stat&#39;</span><span class="p">,</span> <span class="s1">&#39;--name-only&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">modified_ref</span><span class="si">}</span><span class="s2">..HEAD&quot;</span>
            <span class="p">),</span>
            <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;^/</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">directories</span> <span class="k">if</span> <span class="n">directory</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">modified</span><span class="p">:</span>
                <span class="c1"># Nothing was modified, do not select anything</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limit to modified test dirs: </span><span class="si">{</span><span class="n">modified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No modified directories between &#39;</span><span class="si">{</span><span class="n">modified_ref</span><span class="si">}</span><span class="s2">..HEAD&#39; found.&quot;</span><span class="p">)</span>
            <span class="c1"># Nothing was modified, do not select anything</span>
            <span class="k">return</span>

    <span class="c1"># Initialize the metadata tree, search for available tests</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check metadata tree in &#39;</span><span class="si">{</span><span class="n">tree_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span>
        <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">tree_path</span><span class="p">,</span>
        <span class="n">fmf_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">_fmf_context</span><span class="p">,</span>
        <span class="n">additional_rules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">adjust_tests</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span>
        <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual is False&quot;</span><span class="p">],</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">links</span><span class="o">=</span><span class="n">link_needles</span><span class="p">,</span>
        <span class="n">includes</span><span class="o">=</span><span class="n">includes</span><span class="p">,</span>
        <span class="n">excludes</span><span class="o">=</span><span class="n">excludes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
        <span class="c1"># Save fmf metadata</span>
        <span class="n">clonedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span>
        <span class="n">clone_tree_path</span> <span class="o">=</span> <span class="n">clonedir</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filter_paths</span><span class="p">(</span><span class="n">tree_path</span><span class="p">,</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;\.fmf&#39;</span><span class="p">]):</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">,</span>
                <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">tree_path</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Save upgrade plan</span>
        <span class="n">upgrade_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upgrade_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upgrade_path</span><span class="p">:</span>
            <span class="n">upgrade_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">upgrade_path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.fmf&quot;</span>
            <span class="p">(</span><span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">,</span> <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copymode</span><span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">,</span> <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">upgrade_path</span><span class="p">)</span>

    <span class="c1"># Prefix tests and handle library requires</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
        <span class="c1"># Propagate `where` key</span>
        <span class="n">test</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverStepData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">where</span>

        <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
            <span class="c1"># Save only current test data</span>
            <span class="k">assert</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="n">relative_test_path</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                <span class="n">tree_path</span> <span class="o">/</span> <span class="n">relative_test_path</span><span class="p">,</span>
                <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">relative_test_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Copy all parent main.fmf files</span>
            <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">relative_test_path</span>
            <span class="k">while</span> <span class="n">parent_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">():</span>
                <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">parent_dir</span><span class="o">.</span><span class="n">parent</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="c1"># Ensure parent directory exists</span>
                    <span class="p">(</span><span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                        <span class="n">tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">,</span>
                        <span class="n">clone_tree_path</span> <span class="o">/</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s1">&#39;main.fmf&#39;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1"># Prefix test path with &#39;tests&#39; and possible &#39;path&#39; prefix</span>
        <span class="k">assert</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
        <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tests&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span> <span class="o">/</span> <span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">unrooted</span><span class="p">()</span>
        <span class="c1"># Check for possible required beakerlib libraries</span>
        <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">require</span> <span class="ow">or</span> <span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">require</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">libraries</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span>
                <span class="n">original_require</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">require</span><span class="p">,</span>
                <span class="n">original_recommend</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">recommend</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="n">source_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
                <span class="n">target_location</span><span class="o">=</span><span class="n">clonedir</span> <span class="k">if</span> <span class="n">prune</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">prune</span><span class="p">:</span>
        <span class="c1"># Clean self.testdir and copy back only required tests and files from clonedir</span>
        <span class="c1"># This is to have correct paths in tests</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">clonedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="c1"># Cleanup clone directories</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clone_dirpath</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.get_git_root" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_git_root</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.get_git_root" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Find git root of the path</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_git_root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find git root of the path</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-toplevel&quot;</span><span class="p">),</span>
        <span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
        <span class="n">ignore_dry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">output</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.go" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">go</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.go" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Discover available tests</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover available tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># Check url and path, prepare test directory</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
    <span class="c1"># FIXME: cast() - typeless &quot;dispatcher&quot; method</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="c1"># Save the test directory so that others can reference it</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;tests&#39;</span>
    <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>
    <span class="n">dist_git_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-source&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">dist_git_merge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-merge&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># No tests are selected in some cases</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">Test</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Self checks</span>
    <span class="k">if</span> <span class="n">dist_git_source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dist_git_merge</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ref</span> <span class="ow">or</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot manipulate with dist-git without the `--dist-git-merge` option.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_import_plan_details</span><span class="p">()</span>

    <span class="c1"># Clone provided git repository (if url given) with disabled</span>
    <span class="c1"># prompt to ignore possibly missing or private repositories</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clone &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="c1"># Shallow clone to speed up testing and</span>
        <span class="c1"># minimize data transfers if ref is not provided</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_clone</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="n">shallow</span><span class="o">=</span><span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">Environment</span><span class="p">({</span><span class="s2">&quot;GIT_ASKPASS&quot;</span><span class="p">:</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)}),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span>
    <span class="c1"># Copy git repository root to workdir</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmf_root</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmf_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">fmf_root</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">fmf_root</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">requires_git</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt</span><span class="p">(</span><span class="s1">&#39;sync-repo&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REQUIRES_GIT</span>
        <span class="p">)</span>
        <span class="c1"># Path for distgit sources cannot be checked until the</span>
        <span class="c1"># they are extracted</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dist_git_source</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Provided path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; is not a directory.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist_git_source</span><span class="p">:</span>
            <span class="c1"># Ensure we&#39;re in a git repo when extracting dist-git sources</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2"> is not a git repo&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmf_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;No metadata found in the current directory.&quot;</span><span class="p">)</span>
            <span class="c1"># Check git repository root (use fmf root if not found)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">fmf_root</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Git root not found, using &#39;</span><span class="si">{</span><span class="n">fmf_root</span><span class="si">}</span><span class="s2">.&#39;&quot;</span><span class="p">)</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="n">fmf_root</span>
            <span class="c1"># Set path to relative path from the git root to fmf root</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">fmf_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span>
                <span class="n">git_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span> <span class="k">if</span> <span class="n">requires_git</span> <span class="k">else</span> <span class="n">fmf_root</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="c1"># And finally copy the git/fmf root directory to testdir</span>
        <span class="c1"># (for dist-git case only when merge explicitly requested)</span>
        <span class="k">if</span> <span class="n">requires_git</span><span class="p">:</span>
            <span class="n">directory</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">git_root</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">fmf_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">fmf_root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_source</span> <span class="ow">or</span> <span class="n">dist_git_merge</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="c1"># Prepare path of the dynamic reference</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">resolve_dynamic_ref</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
            <span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
            <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">FileError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

    <span class="c1"># Checkout revision if requested</span>
    <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkout ref &#39;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">)</span>

    <span class="c1"># Show current commit hash if inside a git repository</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">(</span>
                <span class="s1">&#39;hash&#39;</span><span class="p">,</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_hash</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">),</span>
                <span class="s1">&#39;green&#39;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="c1"># Dist-git source processing during discover step</span>
    <span class="k">if</span> <span class="n">dist_git_source</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">distgit_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="k">if</span> <span class="n">ref</span> <span class="k">else</span> <span class="n">git_root</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_distgit_source</span><span class="p">(</span><span class="n">distgit_dir</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;Failed to process &#39;dist-git-source&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">error</span>

    <span class="c1"># Discover tests</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_the_discovery</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c1"># Apply tmt run policy</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.post_dist_git" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">post_dist_git</span><span class="p">(</span><span class="n">created_content</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.post_dist_git" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Discover tests after dist-git applied patches</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">post_dist_git</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">created_content</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover tests after dist-git applied patches</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Directory to copy out from sources</span>
    <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-extract&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">dist_git_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-init&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">dist_git_merge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-merge&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">dist_git_remove_fmf_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-remove-fmf-root&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
    <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>

    <span class="c1"># &#39;/&#39; means everything which was extracted from the srpm and do not flatten</span>
    <span class="c1"># glob otherwise</span>
    <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="ow">and</span> <span class="n">dist_git_extract</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
                <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sourcedir</span> <span class="o">/</span> <span class="n">dist_git_extract</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t glob &#39;</span><span class="si">{</span><span class="n">dist_git_extract</span><span class="si">}</span><span class="s2">&#39; within extracted sources.&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">dist_git_init</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dist_git_extract</span><span class="p">:</span>
            <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">sourcedir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">dist_git_extract</span>
        <span class="c1"># User specified location or &#39;root&#39; of extracted sources</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.fmf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
            <span class="n">fmf</span><span class="o">.</span><span class="n">Tree</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dist_git_remove_fmf_root</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extracted_fmf_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_fmf_root</span><span class="p">(</span>
                <span class="n">sourcedir</span><span class="p">,</span>
                <span class="n">ignore_paths</span><span class="o">=</span><span class="p">[</span><span class="n">sourcedir</span><span class="p">],</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No fmf root to remove, there isn&#39;t one already.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">((</span><span class="n">dist_git_extract</span> <span class="ow">or</span> <span class="n">extracted_fmf_root</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;.fmf&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_extract</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">top_fmf_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">find_fmf_root</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">,</span> <span class="n">ignore_paths</span><span class="o">=</span><span class="p">[</span><span class="n">sourcedir</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">MetadataError</span><span class="p">:</span>
            <span class="n">dist_git_extract</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>  <span class="c1"># Copy all extracted files as well (but later)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dist_git_merge</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Extracted sources do not contain fmf root, &quot;</span>
                    <span class="s2">&quot;merging with plan data. Avoid this warning by &quot;</span>
                    <span class="s2">&quot;explicit use of the &#39;--dist-git-merge&#39; option.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># FIXME - Deprecate this behavior?</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_git_root</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy &#39;</span><span class="si">{</span><span class="n">git_root</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
                    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span><span class="n">git_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="c1"># Copy extracted sources into testdir</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dry_run</span><span class="p">:</span>
        <span class="n">flatten</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">dist_git_extract</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">flatten</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">copy_these</span> <span class="o">=</span> <span class="n">created_content</span>
        <span class="k">elif</span> <span class="n">dist_git_extract</span><span class="p">:</span>
            <span class="n">copy_these</span> <span class="o">=</span> <span class="p">[</span><span class="n">dist_git_extract</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copy_these</span> <span class="o">=</span> <span class="p">[</span><span class="n">top_fmf_root</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">to_copy</span> <span class="ow">in</span> <span class="n">copy_these</span><span class="p">:</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">sourcedir</span> <span class="o">/</span> <span class="n">to_copy</span>
            <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
                    <span class="n">sourcedir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="k">if</span> <span class="n">flatten</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testdir</span> <span class="o">/</span> <span class="n">to_copy</span><span class="p">)</span>

    <span class="c1"># Discover tests</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_the_discovery</span><span class="p">()</span>

    <span class="c1"># Add TMT_SOURCE_DIR variable for each test</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
        <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

    <span class="c1"># Apply tmt run policy</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="c1"># Inject newly found tests into parent discover at the right position</span>
    <span class="c1"># FIXME</span>
    <span class="c1"># Prefix test name only if multiple plugins configured</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">phases</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
    <span class="c1"># Check discovered tests, modify test name/path</span>
    <span class="k">for</span> <span class="n">test_origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">test_origin</span><span class="o">.</span><span class="n">test</span>

        <span class="n">test</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">test</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">safe_name</span><span class="si">}{</span><span class="n">test</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Update test environment with plan environment</span>
        <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">_tests</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="n">test</span><span class="o">.</span><span class="n">serial_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">draw_test_serial_number</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.process_distgit_source" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_distgit_source</span><span class="p">(</span><span class="n">distgit_dir</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.process_distgit_source" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process dist-git source during the discover step.</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_distgit_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distgit_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process dist-git source during the discover step.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">download_distgit_source</span><span class="p">(</span>
        <span class="n">distgit_dir</span><span class="o">=</span><span class="n">distgit_dir</span><span class="p">,</span>
        <span class="n">target_dir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
        <span class="n">handler_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-type&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Copy rest of files so TMT_SOURCE_DIR has patches, sources and spec file</span>
    <span class="c1"># FIXME &#39;worktree&#39; could be used as sourcedir when &#39;url&#39; is not set</span>
    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">filesystem</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">(</span>
        <span class="n">distgit_dir</span><span class="p">,</span>
        <span class="n">sourcedir</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># patch &amp; rediscover will happen later in the prepare step</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist-git-download-only&#39;</span><span class="p">):</span>
        <span class="c1"># Check if prepare is enabled, warn user if not</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Sources will not be extracted, prepare step is not enabled.&quot;</span><span class="p">)</span>

        <span class="n">insert_to_prepare_step</span><span class="p">(</span>
            <span class="n">discover_plugin</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">sourcedir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># merge or not, detect later</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">extract_tests_later</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tests will be discovered after dist-git patching in prepare.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.fmf.DiscoverFmf.tests" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tests</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">phase_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.fmf.DiscoverFmf.tests" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return all discovered tests</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/fmf.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">tests</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return all discovered tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phase_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
        <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">is</span> <span class="n">enabled</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="shell">shell<a class="headerlink" href="#shell" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="tmt.steps.discover.shell.DiscoverShell" class="doc doc-heading">
            <code>tmt.steps.discover.shell.DiscoverShell</code>


<a href="#tmt.steps.discover.shell.DiscoverShell" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="tmt.steps.discover.DiscoverPlugin">DiscoverPlugin</span>[<span title="tmt.steps.discover.shell.DiscoverShellData">DiscoverShellData</span>]</code></p>


        <p>Use provided list of shell script tests.</p>
<p>List of test cases to be executed can be defined manually directly
in the plan as a list of dictionaries containing test <code>name</code> and
actual <code>test</code> script. It is also possible to define here any other
test metadata such as the <code>duration</code> or a <code>path</code> to the test.
The default duration for tests defined directly in the discover step
is <code>1h</code>.</p>
<p>Example config:</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: shell
    tests:
      - name: /help/main
        test: tmt --help
      - name: /help/test
        test: tmt test --help
      - name: /help/smoke
        test: ./smoke.sh
        path: /tests/shell
</code></pre></div>
<p>For DistGit repo one can download sources and use code from them in
the tests. Sources are extracted into <code>$TMT_SOURCE_DIR</code> path,
patches are applied by default. See options to install build
dependencies or to just download sources without applying patches.
To apply patches, special <code>prepare</code> phase with order <code>60</code> is
added, and <code>prepare</code> step has to be enabled for it to run.</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: shell
    dist-git-source: true
    tests:
      - name: /upstream
        test: cd $TMT_SOURCE_DIR/*/tests &amp;&amp; make test
</code></pre></div>
<p>To clone a remote repository and use it as a source specify <code>url</code>.
It accepts also <code>ref</code> to checkout provided reference. Dynamic
reference feature is supported as well.</p>
<p>.. code-block:: yaml</p>
<div class="highlight"><pre><span></span><code>discover:
    how: shell
    url: https://github.com/teemtee/tmt.git
    ref: &quot;1.18.0&quot;
    tests:
      - name: first test
        test: ./script-from-the-repo.sh
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>tmt/steps/discover/shell.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">provides_method</span><span class="p">(</span><span class="s1">&#39;shell&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DiscoverShell</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverPlugin</span><span class="p">[</span><span class="n">DiscoverShellData</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use provided list of shell script tests.</span>

<span class="sd">    List of test cases to be executed can be defined manually directly</span>
<span class="sd">    in the plan as a list of dictionaries containing test ``name`` and</span>
<span class="sd">    actual ``test`` script. It is also possible to define here any other</span>
<span class="sd">    test metadata such as the ``duration`` or a ``path`` to the test.</span>
<span class="sd">    The default duration for tests defined directly in the discover step</span>
<span class="sd">    is ``1h``.</span>

<span class="sd">    Example config:</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: shell</span>
<span class="sd">            tests:</span>
<span class="sd">              - name: /help/main</span>
<span class="sd">                test: tmt --help</span>
<span class="sd">              - name: /help/test</span>
<span class="sd">                test: tmt test --help</span>
<span class="sd">              - name: /help/smoke</span>
<span class="sd">                test: ./smoke.sh</span>
<span class="sd">                path: /tests/shell</span>

<span class="sd">    For DistGit repo one can download sources and use code from them in</span>
<span class="sd">    the tests. Sources are extracted into ``$TMT_SOURCE_DIR`` path,</span>
<span class="sd">    patches are applied by default. See options to install build</span>
<span class="sd">    dependencies or to just download sources without applying patches.</span>
<span class="sd">    To apply patches, special ``prepare`` phase with order ``60`` is</span>
<span class="sd">    added, and ``prepare`` step has to be enabled for it to run.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: shell</span>
<span class="sd">            dist-git-source: true</span>
<span class="sd">            tests:</span>
<span class="sd">              - name: /upstream</span>
<span class="sd">                test: cd $TMT_SOURCE_DIR/*/tests &amp;&amp; make test</span>

<span class="sd">    To clone a remote repository and use it as a source specify ``url``.</span>
<span class="sd">    It accepts also ``ref`` to checkout provided reference. Dynamic</span>
<span class="sd">    reference feature is supported as well.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">        discover:</span>
<span class="sd">            how: shell</span>
<span class="sd">            url: https://github.com/teemtee/tmt.git</span>
<span class="sd">            ref: &quot;1.18.0&quot;</span>
<span class="sd">            tests:</span>
<span class="sd">              - name: first test</span>
<span class="sd">                test: ./script-from-the-repo.sh</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_data_class</span> <span class="o">=</span> <span class="n">DiscoverShellData</span>

    <span class="n">_tests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Test</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show config details</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">([])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">]))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_remote_repository</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">testdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">keep_git_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch remote git repo from given url to testdir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Nothing to do if no url provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Clone first - it might clone dist git</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_clone</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span>
            <span class="n">shallow</span><span class="o">=</span><span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">Environment</span><span class="p">({</span><span class="s2">&quot;GIT_ASKPASS&quot;</span><span class="p">:</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)}),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Resolve possible dynamic references</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">resolve_dynamic_ref</span><span class="p">(</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">FileError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

        <span class="c1"># Checkout revision if requested</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkout ref &#39;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">testdir</span><span class="p">)</span>

        <span class="c1"># Log where HEAD leads to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_hash</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">))</span>

        <span class="c1"># Remove .git so that it&#39;s not copied to the SUT</span>
        <span class="c1"># if &#39;keep-git-metadata&#39; option is not specified</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_git_metadata</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">testdir</span> <span class="o">/</span> <span class="s1">&#39;.git&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discover available tests</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">tests</span> <span class="o">=</span> <span class="n">fmf</span><span class="o">.</span><span class="n">Tree</span><span class="p">({</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;tests&#39;</span><span class="p">})</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">testdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log_import_plan_details</span><span class="p">()</span>

        <span class="c1"># dist-git related</span>
        <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>

        <span class="c1"># Fetch remote repository related</span>

        <span class="c1"># Git metadata are necessary for dist_git_source</span>
        <span class="n">keep_git_metadata</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keep_git_metadata</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fetch_remote_repository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">testdir</span><span class="p">,</span> <span class="n">keep_git_metadata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Symlink tests directory to the plan work tree</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">worktree</span>  <span class="c1"># narrow type</span>

            <span class="n">relative_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">worktree</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="n">testdir</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">keep_git_metadata</span><span class="p">:</span>
                <span class="c1"># Copy .git which is excluded when worktree is initialized</span>
                <span class="n">tree_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                <span class="c1"># If exists, git_root can be only the same or parent of fmf_root</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_root</span><span class="p">(</span><span class="n">fmf_root</span><span class="o">=</span><span class="n">tree_root</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">git_root</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">git_root</span> <span class="o">!=</span> <span class="n">tree_root</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                            <span class="s2">&quot;The &#39;keep-git-metadata&#39; option can be &quot;</span>
                            <span class="s2">&quot;used only when fmf root is the same as git root.&quot;</span>
                        <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;rsync&quot;</span><span class="p">,</span> <span class="s2">&quot;-ar&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">git_root</span><span class="si">}</span><span class="s2">/.git&quot;</span><span class="p">,</span> <span class="n">testdir</span><span class="p">))</span>

        <span class="c1"># Check and process each defined shell test</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="c1"># Create data copy (we want to keep original data for save()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># Extract name, make sure it is present</span>
            <span class="c1"># TODO: can this ever happen? With annotations, `name: str` and `test: str`, nothing</span>
            <span class="c1"># should ever assign `None` there and pass the test.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpecificationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing test name in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Make sure that the test script is defined</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpecificationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing test script in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Prepare path to the test working directory (tree root by default)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/tests</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;/tests&#39;</span>
            <span class="c1"># Apply default test duration unless provided</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_TEST_DURATION_L2</span>
            <span class="c1"># Add source dir path variable</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

            <span class="c1"># Create a simple fmf node, with correct name. Emit only keys and values</span>
            <span class="c1"># that are no longer default. Do not add `name` itself into the node,</span>
            <span class="c1"># it&#39;s not a supported test key, and it&#39;s given to the node itself anyway.</span>
            <span class="c1"># Note the exception for `duration` key - it&#39;s expected in the output</span>
            <span class="c1"># even if it still has its default value.</span>
            <span class="n">test_fmf_keys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">to_spec</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;name&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;duration&#39;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">test_fmf_keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">run_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-toplevel&quot;</span><span class="p">),</span>
                    <span class="n">cwd</span><span class="o">=</span><span class="n">testdir</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                    <span class="n">ignore_dry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">run_result</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">git_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">run_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Directory &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&#39; is not a git repository.&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download_distgit_source</span><span class="p">(</span>
                    <span class="n">distgit_dir</span><span class="o">=</span><span class="n">git_root</span><span class="p">,</span>
                    <span class="n">target_dir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
                    <span class="n">handler_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_type</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># Copy rest of files so TMT_SOURCE_DIR has patches, sources and spec file</span>
                <span class="c1"># FIXME &#39;worktree&#39; could be used as sourcedir when &#39;url&#39; is not set</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">git_root</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_download_only</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Do not extract sources as &#39;download_only&#39; is set.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Check if prepare is enabled, warn user if not</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Sources will not be extracted, prepare step is not enabled.&quot;</span><span class="p">)</span>
                    <span class="n">insert_to_prepare_step</span><span class="p">(</span>
                        <span class="n">discover_plugin</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">sourcedir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;Failed to process &#39;dist-git-source&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">error</span>

        <span class="c1"># Use a tmt.Tree to apply possible command line filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span>
            <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual is False&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Propagate `where` key and TMT_SOURCE_DIR</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverStepData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">where</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

        <span class="c1"># Apply tmt run policy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
                <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">tests</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">phase_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">phase_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">phase_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">enabled</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">TestOrigin</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span>
            <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">is</span> <span class="n">enabled</span>
        <span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.shell.DiscoverShell.fetch_remote_repository" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fetch_remote_repository</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">testdir</span><span class="p">,</span> <span class="n">keep_git_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.shell.DiscoverShell.fetch_remote_repository" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Fetch remote git repo from given url to testdir</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/shell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fetch_remote_repository</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">ref</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">testdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">keep_git_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch remote git repo from given url to testdir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Nothing to do if no url provided</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Clone first - it might clone dist git</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_clone</span><span class="p">(</span>
        <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
        <span class="n">destination</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span>
        <span class="n">shallow</span><span class="o">=</span><span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">Environment</span><span class="p">({</span><span class="s2">&quot;GIT_ASKPASS&quot;</span><span class="p">:</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)}),</span>
        <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Resolve possible dynamic references</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">resolve_dynamic_ref</span><span class="p">(</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">FileError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>

    <span class="c1"># Checkout revision if requested</span>
    <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkout ref &#39;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">),</span> <span class="n">cwd</span><span class="o">=</span><span class="n">testdir</span><span class="p">)</span>

    <span class="c1"># Log where HEAD leads to</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_hash</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">testdir</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">))</span>

    <span class="c1"># Remove .git so that it&#39;s not copied to the SUT</span>
    <span class="c1"># if &#39;keep-git-metadata&#39; option is not specified</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_git_metadata</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">testdir</span> <span class="o">/</span> <span class="s1">&#39;.git&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.shell.DiscoverShell.go" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">go</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.shell.DiscoverShell.go" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Discover available tests</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/shell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tmt</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discover available tests</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">fmf</span><span class="o">.</span><span class="n">Tree</span><span class="p">({</span><span class="s1">&#39;summary&#39;</span><span class="p">:</span> <span class="s1">&#39;tests&#39;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">testdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s2">&quot;tests&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log_import_plan_details</span><span class="p">()</span>

    <span class="c1"># dist-git related</span>
    <span class="n">sourcedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">/</span> <span class="s1">&#39;source&#39;</span>

    <span class="c1"># Fetch remote repository related</span>

    <span class="c1"># Git metadata are necessary for dist_git_source</span>
    <span class="n">keep_git_metadata</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keep_git_metadata</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_remote_repository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ref</span><span class="p">,</span> <span class="n">testdir</span><span class="p">,</span> <span class="n">keep_git_metadata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Symlink tests directory to the plan work tree</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">worktree</span>  <span class="c1"># narrow type</span>

        <span class="n">relative_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">worktree</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="n">testdir</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keep_git_metadata</span><span class="p">:</span>
            <span class="c1"># Copy .git which is excluded when worktree is initialized</span>
            <span class="n">tree_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="c1"># If exists, git_root can be only the same or parent of fmf_root</span>
            <span class="n">git_root</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">git_root</span><span class="p">(</span><span class="n">fmf_root</span><span class="o">=</span><span class="n">tree_root</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">git_root</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">git_root</span> <span class="o">!=</span> <span class="n">tree_root</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                        <span class="s2">&quot;The &#39;keep-git-metadata&#39; option can be &quot;</span>
                        <span class="s2">&quot;used only when fmf root is the same as git root.&quot;</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Command</span><span class="p">(</span><span class="s2">&quot;rsync&quot;</span><span class="p">,</span> <span class="s2">&quot;-ar&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">git_root</span><span class="si">}</span><span class="s2">/.git&quot;</span><span class="p">,</span> <span class="n">testdir</span><span class="p">))</span>

    <span class="c1"># Check and process each defined shell test</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
        <span class="c1"># Create data copy (we want to keep original data for save()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Extract name, make sure it is present</span>
        <span class="c1"># TODO: can this ever happen? With annotations, `name: str` and `test: str`, nothing</span>
        <span class="c1"># should ever assign `None` there and pass the test.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpecificationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing test name in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Make sure that the test script is defined</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">SpecificationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Missing test script in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Prepare path to the test working directory (tree root by default)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/tests</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;/tests&#39;</span>
        <span class="c1"># Apply default test duration unless provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">DEFAULT_TEST_DURATION_L2</span>
        <span class="c1"># Add source dir path variable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

        <span class="c1"># Create a simple fmf node, with correct name. Emit only keys and values</span>
        <span class="c1"># that are no longer default. Do not add `name` itself into the node,</span>
        <span class="c1"># it&#39;s not a supported test key, and it&#39;s given to the node itself anyway.</span>
        <span class="c1"># Note the exception for `duration` key - it&#39;s expected in the output</span>
        <span class="c1"># even if it still has its default value.</span>
        <span class="n">test_fmf_keys</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">to_spec</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;name&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;duration&#39;</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">tests</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">test_fmf_keys</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">Command</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-toplevel&quot;</span><span class="p">),</span>
                <span class="n">cwd</span><span class="o">=</span><span class="n">testdir</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">url</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                <span class="n">ignore_dry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">run_result</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">git_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">run_result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">RunError</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># narrow type</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Directory &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">&#39; is not a git repository.&quot;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download_distgit_source</span><span class="p">(</span>
                <span class="n">distgit_dir</span><span class="o">=</span><span class="n">git_root</span><span class="p">,</span>
                <span class="n">target_dir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
                <span class="n">handler_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Copy rest of files so TMT_SOURCE_DIR has patches, sources and spec file</span>
            <span class="c1"># FIXME &#39;worktree&#39; could be used as sourcedir when &#39;url&#39; is not set</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">git_root</span><span class="p">,</span> <span class="n">sourcedir</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_download_only</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Do not extract sources as &#39;download_only&#39; is set.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Check if prepare is enabled, warn user if not</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Sources will not be extracted, prepare step is not enabled.&quot;</span><span class="p">)</span>
                <span class="n">insert_to_prepare_step</span><span class="p">(</span>
                    <span class="n">discover_plugin</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">sourcedir</span><span class="o">=</span><span class="n">sourcedir</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">DiscoverError</span><span class="p">(</span><span class="s2">&quot;Failed to process &#39;dist-git-source&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">error</span>

    <span class="c1"># Use a tmt.Tree to apply possible command line filters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">tmt</span><span class="o">.</span><span class="n">Tree</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="n">tests</span><span class="p">)</span><span class="o">.</span><span class="n">tests</span><span class="p">(</span>
        <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual is False&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="c1"># Propagate `where` key and TMT_SOURCE_DIR</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
        <span class="n">test</span><span class="o">.</span><span class="n">where</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">steps</span><span class="o">.</span><span class="n">discover</span><span class="o">.</span><span class="n">DiscoverStepData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">where</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dist_git_source</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="s1">&#39;TMT_SOURCE_DIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EnvVarValue</span><span class="p">(</span><span class="n">sourcedir</span><span class="p">)</span>

    <span class="c1"># Apply tmt run policy</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="o">.</span><span class="n">plan</span><span class="o">.</span><span class="n">my_run</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">apply_to_tests</span><span class="p">(</span><span class="n">tests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tests</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="tmt.steps.discover.shell.DiscoverShell.show" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">show</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#tmt.steps.discover.shell.DiscoverShell.show" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Show config details</p>


            <details class="quote">
              <summary>Source code in <code>tmt/steps/discover/shell.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show config details</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">([])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
        <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="n">tmt</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">test</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tests</span><span class="p">]))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>













              </article>
            </div>


<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>

      </main>

        <footer class="md-footer">

  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">


    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>

</div>

    </div>
  </div>
</footer>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>




      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>


      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>


  </body>
</html>